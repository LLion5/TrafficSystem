/*********************************************************************************
* ??¡À¨¤D¡ä¨º¡À????¡êo 2016?¨º12??9¨¨?
* ??¡Á¡Â    ????¡êo ???¨¨¦Ì?¡Á¨®:03
* ??¡ã?    ¡À???¡êo 1.0
* ??¨ª?    ????¡êo http://www.qxmcu.com/ 
* ??¨¬?¡À|¦Ì¨º?¨¬??¡êo http://qxmcu.taobao.com/ (?¡À?¨²¦Ì¨º)
* ??¨º¦Ì?¨¦??¨¬¡§??¡êo QX-MCS51 ¦Ì£¤???¨²?a¡¤¡é¡ã? & QX-A51???¨¹D?3¦Ì
* ??¨ªa2??¡ì????¡êo 11.0592mhz	
* ???¡Â??D?????¡êo STC89C52
* ??¡À¨¤¨°??¡¤?3??¡êo Keil |¨¬Visio4
* ********************************???¨®???¦Ì?¡Â??********************************
             ¨°???"A_"¡À¨ª¨º????¨¹D?3¦Ì¦Ì¡Á¡ã?~~~"B_"¡À¨ª¨º??a¡¤¡é¡ã?     
*?a¡¤¡é¡ã?1?¦Ì???  ¡êoA_J5-VCC~~~B_VCC?¨°5V0    A_J6-GND~~~B_GND ¡ê¡§¨°?12¨º1¨®?2?¨´??¡ã???¡ê?
*¦Ì??¨²??????    ¡êoA_J10-P1.2?¨¢P1.7 ??¨®|?¨®¦Ì?B_P1.2?¨¢P1.7 ¡ê¡§¨°?12¨º1¨®?6?¨´??¡ã???¡ê?
******************************************************************************
* ??3¨¬D¨°1|?¨¹??¡êoQX-A51???¨¹D?3¦Ìo¨¬¨ªa?T??¨°¡ê??		   			            			    
* ??¨º1¨®??¦Ì?¡Â??¡êoD?3¦Ì¨¦?¦Ì?o¨®¡ã¡ä¨°¡ê???¡Â?¡ã2?¡À?¨¹?¡äDD?¡ã???¡é¡ã¡ä?¡ã8?¡À?¨¹?¡äDDo¨®¨ª?
				¡ã¡ä?¡ã4?¡À?¨¹?¡äDD¡Á¨®¡Áa?¡é¡ã¡ä?¡ã6?¡À?¨¹¨®¨°¡Áa?¡é¡ã¡ä?¡ã5?¡À?¨¹¨ª¡ê?1
* ??¡Á¡é¨°a¨º?????¡êo¡À¨¹?aD?3¦Ì¡Á2?¨°??¡ã-???¨°D?3¦Ì??¡Á¨®??¡Áa¡ê?D?3¦Ì¦Ì??12??¨¹¦Ì¨ª¨®¨²6V
				1?¡é?a¡¤¡é¡ã?P32???¨²2??¨¹?¨®??¡ã???¡ê?¡¤??¨°?T¡¤¡§¨°¡ê???¡ê
				2?¡é¨°¡ê??¨º¡À¨°¡ê???¡Â??¨¢???¡Á??a¡¤¡é¡ã?¨¦?o¨¬¨ªa?¨®¨º?¨ª¡¤?¡ê
				3?¡é¨¨?2??¨¢o¨¬¨ªa?a??¦Ì?¨ª??¡ì¡ê????¡ä?a¡¤¡é¡ã???¨¬¡Á¨º¨®?¦Ì?D¦Ì?o¨¬¨ªa?a?????¨²¡ê?¨°?122D?¨º¡À??3¨¬?¡ê
**********************************************************************************/
#include <reg52.h> //51¨ª¡¤???t
#include <MOTOR.h>//QX-A51???¨¹D?3¦Ì???????t

/*====================================
 ¡Á??¡§¨°?¨¤¨¤D¨ª??
====================================*/
typedef unsigned char INT8U;
typedef unsigned char uchar;

typedef unsigned int INT16U;
typedef unsigned int uint;

unsigned char pwm_left_val = 170;//¡Á¨®¦Ì??¨²????¡À¨¨?¦Ì ¨¨??¦Ì¡¤??¡ì0-170¡ê?0¡Á??¨¬
unsigned char pwm_right_val = 170;//¨®¨°¦Ì??¨²????¡À¨¨?¦Ì¨¨??¦Ì¡¤??¡ì0-170 ,0¡Á??¨¬
unsigned char pwm_t;//?¨¹?¨²

/*====================================
 ¨®2?t?¨®?¨²??¨¦¨´?¡Â
====================================*/
sbit IR  = P3^2;     //?¡§¨°?o¨¬¨ªa??3?¨ºy?Y?¨®?¨²	¨ªa2??D??O¨º?¨¨??¨²

uchar IRtime; 		//?¨¬2ao¨¬¨ªa??¦Ì???3?D?¨º¡À??¡ê¡§???¨ª¡ê?
uchar IRcord[4];    //¡ä?¨ºy¡Á¨¦¨®?¨®¨²¡ä¡é¡ä?¡¤?¨¤?3?¨¤¡ä¦Ì?4??¡Á??¨²¦Ì?¨ºy?Y¡ê¡§¨®??¡ì??2??¡Á??¨²+?¨¹?¦Ì??2??¡Á??¨²¡ê?
uchar IRdata[33];   //¡ä?¨ºy¡Á¨¦¨®?¨®¨²¡ä¡é¡ä?o¨¬¨ªa¦Ì?33??¨ºy?Y¡ê¡§¦Ì¨²¨°????a¨°y¦Ì???¨®??¡ì??16+?¨¹?¦Ì??16¡ê?
bit IRpro_ok, IRok;  //¦Ì¨²¨°???¨®?¨®¨²o¨¬¨ªa?¨®¨º?4??¡Á??¨²¨ª¨º¡À??¡êIRok¨®??a?¨¬2a???¨ª¨ª¨º¡À?

void init()	   //3?¨º??¡¥?¡§¨º¡À?¡Â0 o¨ª¨ªa2??D??0
{
	TMOD = 0x22; //?¡§¨º¡À?¡Â0\11¡è¡Á¡Â¡¤?¨º?2¡ê?8??¡Á??¡¥??¡Á¡ã
	
	TH0 = 0x00;  //??8??¡Á¡ã¨¨?0???¡ä?¡§¨º¡À?¡Â¨°?3?¨°?¡ä?¦Ì?¨º¡À??¨º?256???¨²?¡Â?¨¹?¨²
	TL0 = 0x00;
	
	TH1 = 220;
	TL1 = 220;//11.0592M?¡ì????????¡À¨¨¡Á?¡ä¨®¡À¨¨?¦Ì¨º?256,¨º?3?100HZ
	
	EA = 1;      //¡Á¨¹?D??
	
	ET0 = 1;	   //?¡§¨º¡À?¡Â0?D??
	TR0 = 1;     //???¡¥?¡§¨º¡À?¡Â0
	
	ET1 = 1;	   //?¡§¨º¡À?¡Â1?D??
	//TR1 = 1;     //???¡¥?¡§¨º¡À?¡Â1

	IT0 = 1;	   //¨¦¨¨??¨ªa2??D??0?a¨¬???¡ä£¤¡¤¡é¡¤?¨º?¡ê?¨¤¡ä¨°??????¦Ì??¡ä£¤¡¤¡é¨°?¡ä?
	EX0 = 1;	   //???¡¥¨ªa2??D??0
	
}

void time0() interrupt 1   //?¡§¨°??¡§¨º¡À?¡Â0
{
	TR0 = 0;
	IRtime++; 			   //?¨¬2a???¨ª¡ê?1¡ä??a278us
	TR0 = 1;
}

//?¡§¨º¡À?¡Â1?D??
void timer1() interrupt 3
{
	pwm_t++;//?¨¹?¨²??¨º¡À?¨®
	if(pwm_t == 255)
		pwm_t = EN1 = EN2 = 0;
	if(pwm_left_val == pwm_t)//¡Á¨®¦Ì??¨²????¡À¨¨	
		EN1 = 1;		
	if(pwm_right_val == pwm_t)//¨®¨°¦Ì??¨²????¡À¨¨
		EN2 = 1;			 
}

void int0() interrupt 0	  		//?¡§¨°?¨ªa2??D??0
{
	static uchar i;	 			//	¨¦¨´?¡Â?2¨¬?¡À?¨¢?¡ê¡§?¨²¨¬?3?o¡¥¨ºyo¨®?¨²??¨¤¡ä?¡äDD¦Ì?¨º¡Ào¨°2??¨¢?a¨º¡ì¨ºy?¦Ì¡ê?i¨®?¨®¨²¡ã?33¡ä???¦Ì???¦Ì?3?D?¨º¡À??¡ä?¨¨?IRdata
	static bit startflag;		//?a¨º?¡ä¡é¡ä????¨ª¡À¨º????
	if(startflag)	 			//?a¨º??¨®¨º????¨ª?¨¬2a
	{
		if( (IRtime < 53) && (IRtime >= 32) ) /*?D??¨º?¡¤?¨º?¨°y¦Ì???¡ê?¦Ì¡Á¦Ì???9000us+??4500us	
		?a??¡Á??o?¨¦¨°????¨°¨°?11.0592¨¤¡ä??¨¢?NECD-¨°¨¦¦Ì?¨°y¦Ì???¦Ì¨ª8000-10000+??4000-5000 
		¨¨?1?¨°??-?¨®¨º?¨¢?¨°y¦Ì??????¡äi2??¨¢¡À???0?¨ª?¨¢?a¨º?¨°¨¤¡ä?¡ä?¨¨????¨ª*/
			i = 0;				 //¨¨?1?¨º?¨°y¦Ì??????¡ä?¡äDDi=0¡ã???¡ä?¦Ì?IRdata¦Ì?¦Ì¨²¨°?????
		IRdata[i] = IRtime;  		 //¨°?T0¦Ì?¨°?3?¡ä?¨ºy¨¤¡ä???????¨ª¡ê?¡ã??a??¨º¡À??¡ä?¦Ì?¨ºy¡Á¨¦¨¤???¦Ì?o¨®???D??
		IRtime = 0;				 //??¨ºy??¨¢?¡ê???¨°??????¦Ì??¦Ì?¨º¡Ào¨°?¨²¡ä?¨¨????¨ª
		i++; 					 //??¨ºy???¨ª¡ä?¨¨?¦Ì?¡ä?¨ºy
		if(i == 33) 				 //¨¨?1?¡ä?¨¨?34¡ä? ¨ºy¡Á¨¦¦Ì???¡À¨º¨º?¡ä¨®0?a¨º?i¦Ì¨¨¨®¨²33¡À¨ª¨º??¡äDD¨¢?34¡ä?
		{
		 	IRok = 1;				 //???¡ä¡À¨ª¨º????¨ª?¨¬2a¨ª¨º¡À?
			i = 0; 				 //¡ã????¨ª??¨ºy??¨¢?¡Á?¡À???¡ä?¡ä?¨¨?
		}
	}
	else		  
	{
		IRtime = 0; 				 //¨°y¦Ì????a¨º???¨¨?¡ã????¨ª??¨ºy??¨¢??a¨º???¨ºy
		startflag = 1;			 //?a¨º?¡ä|¨¤¨ª¡À¨º??????1
	}
}

void IRcordpro()   				 //¨¬¨¢¨¨??¨¹¦Ì?33¡ä????¨ª??DD¨ºy?Y?a??
{
	uchar i, j, k, cord, value;	/*i¨®?¨®¨²¡ä|¨¤¨ª4??¡Á??¨²¡ê?j¨®?¨®¨²¡ä|¨¤¨ª¨°???¡Á??¨²?D??¨°???¡ê?k¨®?¨®¨²33¡ä????¨ª?D¦Ì???¨°???
	cord¨®?¨®¨²¨¨?3????¨ª¦Ì?¨º¡À???D??¨º?¡¤?¡¤?o?1¦Ì????¨ª¨º¡À??*/
	k = 1; 						//¡ä¨®¦Ì¨²¨°??????¨ª?a¨º?¨¨?¡ê??a?¨²¨°y¦Ì??????¨ª
	for(i = 0; i < 4; i++)
	{
		for(j = 0; j < 8; j++)
		{
			cord = IRdata[k];	    //¡ã????¨ª¡ä?¨¨?cord
			if(cord > 5)	 		//¨¨?1????¨ª¡ä¨®¨®¨²?¨°11.0592¦Ì?t0¨°?3??¨º?a??278us*5=1390???¡ä?D???a1
			value = value | 0x80;	/*?¨®¨º?¦Ì?¨º¡Ào¨°¨º??¨¨?¨®¨º?¡Á?¦Ì¨ª??¡ê?
			¡ã?¡Á?¦Ì¨ª???¨¨¡¤?¦Ì?value¦Ì?¡Á??????¨²o¨ª0x08¡ã¡ä???¨°¨°???
			?a?¨´2??¨¢??¡À?valua¦Ì???????¦Ì?¨ºy?¦Ì???¨¢¨¨???¡Á??????a1*/
			if(j < 7)
			{
				value = value >> 1;	//value??¡Á¨®¨°?¨°¨¤¡ä??¨®¨º?8??¨ºy?Y?¡ê
			}
			k++;				//???¡äDD¨°?¡ä????¨ª???¨®1
		}
		IRcord[i] = value;	   //??¡ä|¨¤¨ª¨ª¨º¨°???¡Á??¨²¡ã??¨¹¡¤?¨¨?IRcord¨ºy¡Á¨¦?D?¡ê
		value = 0; 			   //??¨¢?value¡¤?¡À???¡ä??¨²¡ä?¨¨?¨ºy?Y
	}
	IRpro_ok = 1;				   //?¨®¨º?¨ª¨º4??¡Á??¨²o¨®IRpro ok??1¡À¨ª¨º?o¨¬¨ªa?a??¨ª¨º3¨¦	
}
/*PWM????¨º1?¨¹ D?3¦Ì?¡ã??*/
void forward()
{
	left_motor_go; //¡Á¨®¦Ì??¨²?¡ã??
	right_motor_go; //¨®¨°¦Ì??¨²?¡ã??
}

	
/*PWM????¨º1?¨¹ D?3¦Ìo¨®¨ª?*/
void backward()
{
	left_motor_back; //¡Á¨®¦Ì??¨²o¨®¨ª?
	right_motor_back; //¨®¨°¦Ì??¨²o¨®¨ª?	
}


/*PWM????¨º1?¨¹ D?3¦Ì¡Á¨®¡Áa*/
void left_run()
{
	left_motor_stops; //¡Á¨®¦Ì??¨²¨ª¡ê?1
	right_motor_go; //¨®¨°¦Ì??¨²?¡ã??	
}


/*PWM????¨º1?¨¹ D?3¦Ì¨®¨°¡Áa*/
void right_run()
{
	right_motor_stops;//¨®¨°¦Ì??¨²¨ª¡ê?1
	left_motor_go;    //¡Á¨®¦Ì??¨²?¡ã??
}


/*D?3¦Ì¨ª¡ê?1*/
void stop()
{
	right_motor_stops;//¨®¨°¦Ì??¨²¨ª¡ê?1
	left_motor_stops; //¡Á¨®¦Ì??¨²¨ª¡ê?1	
}


void main()
{
	init();	//?¡äDD3?¨º??¡¥?¡§¨º¡À?¡Â0o¨ª¨ªa2??D??0
	EN1 = EN2 = 1;//¨º1?¨¹¡Á¨®¨®¨°¦Ì??¨²
	while(1)	//¡ä¨®?-?¡¤
	{
		
		//forward();
		//TR0 = 1;     //???¡¥?¡§¨º¡À?¡Â0
		if(IRok)    //?D?????¨ª¨º?¡¤??¨¬2a¨ª¨º¡À?                    
		{   
			IRcordpro();//?¨´?Y???¨ª?a??3?4??¡Á??¨²¦Ì?¨ºy?Y
			IRok = 0;	//??D?¦Ì¨¨¡äy???¨ª?¨¬2a
			if(IRpro_ok) //?D??¨º?¡¤??a??¨ª¨º¡À?  
			{
						//TR0 = 0;     //?¡§¨º¡À?¡Â0
		        switch(IRcord[2])
		   		{
				     case 0x18:  forward();
													 //?¡ã??
				             break;
				     case 0x52:  backward();  			 //o¨®¨ª?	 
				             break;
				     case 0x08:  left_run(); 			 //¡Á¨®¡Áa
				             break;
					 case 0x5A:  right_run(); 			 //¨®¨°¡Áa
				             break;
					 case 0x1C:  stop();			     //¨ª¡ê?1
				             break;
					 default:break;
		   		}
				IRpro_ok = 0;
			}
		}	
	}
}